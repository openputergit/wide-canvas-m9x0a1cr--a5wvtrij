<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePost - Content Moderation App</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6F00',
                        secondary: '#8BC34A',
                        accent: '#FFB300',
                        dark: '#333333',
                        light: '#F5E6C5',
                        clay: {
                            light: '#F5E6C5',
                            bg: '#FFF8E8'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FFF8E8;
            min-height: 100vh;
        }

        .clay {
            background-color: #FFFFFF;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .clay-button {
            background-color: #FF6F00;
            border-radius: 16px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.2s ease;
            color: white;
        }

        .clay-button:hover {
            transform: translateY(-3px);
            background-color: #FF8F00;
        }

        .clay-button:active {
            transform: translateY(0);
        }

        .clay-input {
            background-color: #FFFFFF;
            border-radius: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .clay-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.3);
        }

        .clay-card {
            background-color: #FFFFFF;
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: none;
            transition: transform 0.2s ease;
        }

        .clay-card:hover {
            transform: translateY(-2px);
        }

        .processing-overlay {
            background: rgba(255, 255, 255, 0.9);
            display: none;
        }

        .preview-container {
            min-height: 200px;
        }

        .tab-active {
            background-color: #FF6F00;
            color: white;
        }

        .tab {
            border-radius: 16px 16px 0 0;
        }
        
        .media-preview {
            min-height: 250px;
            border: 2px dashed rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .audio-wave {
            display: flex;
            align-items: flex-end;
            height: 60px;
            gap: 3px;
        }
        
        .audio-wave div {
            background-color: #FF6F00;
            width: 4px;
            animation: audio-wave 1.5s infinite ease-in-out;
            border-radius: 2px;
        }
        
        @keyframes audio-wave {
            0%, 100% {
                height: 10px;
            }
            50% {
                height: 40px;
            }
        }
        
        .audio-wave div:nth-child(2) {
            animation-delay: 0.1s;
        }
        .audio-wave div:nth-child(3) {
            animation-delay: 0.2s;
        }
        .audio-wave div:nth-child(4) {
            animation-delay: 0.3s;
        }
        .audio-wave div:nth-child(5) {
            animation-delay: 0.4s;
        }
        
        .nav-item {
            border-radius: 16px;
            transition: all 0.2s ease;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #FF6F00;
            transform: translateY(-3px);
            color: white;
        }

        .loading-spinner {
            display: none;
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #FF6F00;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message-bubble {
            border-radius: 18px;
            padding: 10px 16px;
            max-width: 80%;
            margin-bottom: 8px;
        }

        .message-sent {
            background-color: #FF6F00;
            color: white;
            margin-left: auto;
        }

        .message-received {
            background-color: #F5E6C5;
            color: #333333;
            margin-right: auto;
        }

        /* Custom scrollbar */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .app-logo {
            font-weight: 700;
            background: linear-gradient(90deg, #FF6F00, #FFB300);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        
        .avatar-circle {
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 3px solid #FFFFFF;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Auth Screens -->
    <div id="auth-container" class="max-w-md mx-auto">
        <!-- Login Screen -->
        <div id="login-screen" class="clay p-6 mb-6">
            <h1 class="text-4xl app-logo text-center mb-6">SafePost</h1>
            <h2 class="text-xl font-bold mb-4 text-dark">Login</h2>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block mb-1 font-medium text-dark">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 clay-input" placeholder="your@email.com" required>
                </div>
                <div>
                    <label for="login-password" class="block mb-1 font-medium text-dark">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 clay-input" placeholder="••••••••" required>
                </div>
                <div class="flex justify-center">
                    <div id="login-spinner" class="loading-spinner"></div>
                </div>
                <button type="submit" class="clay-button px-6 py-3 w-full text-lg font-semibold">Log In</button>
                
                <p class="text-center mt-4 text-dark">
                    Don't have an account? 
                    <a href="#" id="show-register" class="text-primary font-bold">Register</a>
                </p>
            </form>
        </div>
        
        <!-- Register Screen -->
        <div id="register-screen" class="clay p-6 hidden">
            <h1 class="text-4xl app-logo text-center mb-6">SafePost</h1>
            <h2 class="text-xl font-bold mb-4 text-dark">Create Account</h2>
            
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block mb-1 font-medium text-dark">Full Name</label>
                    <input type="text" id="register-name" class="w-full p-3 clay-input" placeholder="John Doe" required>
                </div>
                <div>
                    <label for="register-username" class="block mb-1 font-medium text-dark">Username</label>
                    <input type="text" id="register-username" class="w-full p-3 clay-input" placeholder="johndoe" required>
                </div>
                <div>
                    <label for="register-email" class="block mb-1 font-medium text-dark">Email</label>
                    <input type="email" id="register-email" class="w-full p-3 clay-input" placeholder="your@email.com" required>
                </div>
                <div>
                    <label for="register-password" class="block mb-1 font-medium text-dark">Password</label>
                    <input type="password" id="register-password" class="w-full p-3 clay-input" placeholder="••••••••" required>
                </div>
                <div>
                    <label for="register-confirm" class="block mb-1 font-medium text-dark">Confirm Password</label>
                    <input type="password" id="register-confirm" class="w-full p-3 clay-input" placeholder="••••••••" required>
                </div>
                <div class="flex justify-center">
                    <div id="register-spinner" class="loading-spinner"></div>
                </div>
                <button type="submit" class="clay-button px-6 py-3 w-full text-lg font-semibold">Register</button>
                
                <p class="text-center mt-4 text-dark">
                    Already have an account? 
                    <a href="#" id="show-login" class="text-primary font-bold">Login</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Navigation -->
        <div class="max-w-2xl mx-auto mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl app-logo">SafePost</h1>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center">
                        <span id="user-display-name" class="font-medium mr-2 text-dark">User123</span>
                        <img id="user-avatar" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80" class="w-10 h-10 avatar-circle">
                    </div>
                    <button id="logout-btn" class="clay-button px-3 py-1 text-sm font-medium">Logout</button>
                </div>
            </div>
            
            <div class="flex space-x-4 mb-6">
                <button id="nav-feed" class="nav-item clay-card active flex-1 p-3 text-center font-bold bg-white text-dark">
                    <i class="bi bi-house-door text-xl block mx-auto mb-1"></i>
                    Feed
                </button>
                <button id="nav-post" class="nav-item clay-card flex-1 p-3 text-center font-bold bg-white text-dark">
                    <i class="bi bi-plus-square text-xl block mx-auto mb-1"></i>
                    Post
                </button>
                <button id="nav-messages" class="nav-item clay-card flex-1 p-3 text-center font-bold bg-white text-dark">
                    <i class="bi bi-chat-dots text-xl block mx-auto mb-1"></i>
                    Messages
                </button>
                <button id="nav-profile" class="nav-item clay-card flex-1 p-3 text-center font-bold bg-white text-dark">
                    <i class="bi bi-person text-xl block mx-auto mb-1"></i>
                    Profile
                </button>
            </div>
        </div>
        
        <!-- Feed Section -->
        <div id="feed-section" class="max-w-2xl mx-auto">
            <div class="clay p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-dark">Your Feed</h2>
                
                <div id="feed-content" class="space-y-6">
                    <div id="feed-loading" class="py-10 text-center">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-600">Loading feed...</p>
                    </div>
                    
                    <div id="feed-empty" class="py-10 text-center text-gray-500 hidden">
                        <i class="bi bi-emoji-smile text-5xl"></i>
                        <p class="mt-2">No posts yet. Be the first to share something!</p>
                    </div>
                    
                    <div id="postFeed" class="hidden space-y-6"></div>
                </div>
            </div>
        </div>
        
        <!-- Create Post Section -->
        <div id="post-section" class="max-w-2xl mx-auto hidden">
            <!-- Unified Content Sharing Section -->
            <div class="clay p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-dark">Create Post</h2>
                
                <div class="relative mb-6">
                    <textarea id="postCaption" class="w-full p-4 clay-input resize-none h-24" placeholder="What's on your mind?"></textarea>
                    <div id="textWarning" class="hidden absolute right-4 top-4 text-red-500">
                        <i class="bi bi-exclamation-triangle-fill text-2xl"></i>
                        <span class="text-sm font-medium">Inappropriate content detected</span>
                    </div>
                </div>
                
                <!-- Media Type Selector Tabs -->
                <div class="flex mb-4 bg-white rounded-t-2xl">
                    <button id="textOnlyTab" class="tab tab-active px-4 py-2 flex-1 font-medium">Text Only</button>
                    <button id="imageTab" class="tab px-4 py-2 flex-1 font-medium">Add Image</button>
                    <button id="videoTab" class="tab px-4 py-2 flex-1 font-medium">Add Video</button>
                </div>

                <!-- Media Content Area -->
                <div class="mb-6">
                    <!-- Text Only View -->
                    <div id="textOnlyContent" class="text-center py-6 bg-white bg-opacity-50 rounded-b-2xl">
                        <i class="bi bi-chat-square-text text-5xl text-gray-400"></i>
                        <p class="mt-2 text-gray-500">Text-only post</p>
                    </div>

                    <!-- Image Upload View -->
                    <div id="imageContent" class="hidden">
                        <div class="media-preview mb-3" id="imageDropArea">
                            <div id="imageUploadPrompt">
                                <i class="bi bi-image text-5xl block text-gray-400"></i>
                                <p class="mt-2 text-gray-500">Drop your image here or</p>
                                <label for="imageInput" class="cursor-pointer text-primary font-medium">browse files</label>
                                <input type="file" id="imageInput" accept="image/*" class="hidden">
                            </div>
                        </div>
                        
                        <div id="imagePreview" class="hidden relative">
                            <img id="uploadedImage" class="w-full h-auto max-h-96 object-contain rounded-xl" src="" alt="Preview">
                            <div id="imageProcessing" class="processing-overlay absolute inset-0 flex flex-col items-center justify-center rounded-xl">
                                <lottie-player src="https://assets5.lottiefiles.com/packages/lf20_poqmycwy.json" background="transparent" speed="1" style="width: 100px; height: 100px;" loop autoplay></lottie-player>
                                <p class="font-bold">Analyzing content...</p>
                            </div>
                            <div id="imageStatus" class="hidden absolute top-4 right-4 px-4 py-2 rounded-lg font-bold"></div>
                        </div>
                    </div>

                    <!-- Video Upload View -->
                    <div id="videoContent" class="hidden">
                        <div class="media-preview mb-3" id="videoDropArea">
                            <div id="videoUploadPrompt">
                                <i class="bi bi-camera-video text-5xl block text-gray-400"></i>
                                <p class="mt-2 text-gray-500">Drop your video here or</p>
                                <label for="videoInput" class="cursor-pointer text-primary font-medium">browse files</label>
                                <input type="file" id="videoInput" accept="video/*" class="hidden">
                            </div>
                        </div>
                        
                        <div id="videoPreview" class="hidden relative">
                            <video id="uploadedVideo" class="w-full h-auto max-h-96 object-contain rounded-xl" controls></video>
                            <div id="videoProcessing" class="processing-overlay absolute inset-0 flex flex-col items-center justify-center rounded-xl">
                                <lottie-player src="https://assets5.lottiefiles.com/packages/lf20_poqmycwy.json" background="transparent" speed="1" style="width: 100px; height: 100px;" loop autoplay></lottie-player>
                                <p class="font-bold">Analyzing video...</p>
                                
                                <div class="mt-4">
                                    <p class="font-medium mb-2">Audio analysis</p>
                                    <div class="audio-wave">
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                </div>
                            </div>
                            <div id="videoStatus" class="hidden absolute top-4 right-4 px-4 py-2 rounded-lg font-bold"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-center mb-4">
                    <div id="post-spinner" class="loading-spinner"></div>
                </div>
                
                <button id="postButton" class="clay-button px-6 py-3 w-full text-lg font-semibold">
                    Share Post
                </button>
            </div>
        </div>
        
        <!-- Messages Section -->
        <div id="messages-section" class="max-w-2xl mx-auto hidden">
            <div class="clay p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-dark">Messages</h2>
                
                <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <div class="md:w-1/3 clay-card p-3 overflow-y-auto max-h-96">
                        <div class="mb-4">
                            <input type="text" id="search-users" placeholder="Search users..." class="w-full p-2 clay-input text-sm">
                        </div>
                        <div id="chat-list" class="space-y-3">
                            <div id="chat-loading" class="py-4 text-center">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-xs text-gray-600">Loading chats...</p>
                            </div>
                            <!-- Chat list will be populated here -->
                        </div>
                    </div>
                    <div class="md:w-2/3 clay-card p-0 flex flex-col">
                        <!-- Chat Header -->
                        <div id="chat-header" class="p-3 flex items-center bg-white rounded-t-xl">
                            <img id="chat-avatar" src="https://images.unsplash.com/photo-1599566150163-29194dcaad36?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80" class="w-8 h-8 avatar-circle">
                            <span id="chat-username" class="ml-3 font-bold">Username</span>
                            <button id="follow-btn" class="ml-auto clay-button px-2 py-1 text-xs font-medium">Follow</button>
                        </div>
                        
                        <!-- Messages Container -->
                        <div class="messages-container flex-1 overflow-y-auto p-3" style="height: 300px; background-color: #FFF8E8;" id="messages-container">
                            <div id="message-loading" class="flex justify-center items-center h-full">
                                <div class="loading-spinner"></div>
                            </div>
                            <div id="message-content" class="hidden">
                                <!-- Messages will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div class="p-3 bg-white rounded-b-xl">
                            <div class="flex">
                                <input type="text" id="message-input" class="flex-1 p-2 mr-2 clay-input" placeholder="Type a message...">
                                <button id="send-message-btn" class="clay-button px-4 py-2">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Section -->
        <div id="profile-section" class="max-w-2xl mx-auto hidden">
            <div class="clay p-6 mb-8">
                <div class="text-center mb-6">
                    <img id="profile-avatar" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80" class="w-24 h-24 mx-auto avatar-circle mb-3">
                    <h2 id="profile-name" class="text-2xl font-bold text-dark">John Doe</h2>
                    <p id="profile-username" class="text-gray-600">@johndoe</p>
                </div>
                
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="clay-card p-3">
                        <div class="text-2xl font-bold text-dark" id="post-count">0</div>
                        <div class="text-sm text-gray-600">Posts</div>
                    </div>
                    <div class="clay-card p-3">
                        <div class="text-2xl font-bold text-dark" id="followers-count">0</div>
                        <div class="text-sm text-gray-600">Followers</div>
                    </div>
                    <div class="clay-card p-3">
                        <div class="text-2xl font-bold text-dark" id="following-count">0</div>
                        <div class="text-sm text-gray-600">Following</div>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold mb-4 text-dark">Your Posts</h3>
                <div id="profile-loading" class="text-center py-6">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-600">Loading your posts...</p>
                </div>
                <div id="profile-posts" class="grid grid-cols-2 gap-3 hidden"></div>
                
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-dark">People you may know</h3>
                    <div id="suggested-users" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <div id="suggested-loading" class="text-center py-6 col-span-3">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-600">Finding users...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="clay p-6 max-w-md w-full">
            <div class="text-center">
                <i class="bi bi-check-circle-fill text-5xl text-green-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-dark">Post Published!</h3>
                <p class="mb-6 text-dark">Your content passed our safety checks and is now live.</p>
                <button id="closeModalBtn" class="clay-button px-4 py-2 font-medium bg-secondary">Continue</button>
            </div>
        </div>
    </div>
    
    <!-- Blocked Content Modal -->
    <div id="blockedModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="clay p-6 max-w-md w-full">
            <div class="text-center">
                <i class="bi bi-x-circle-fill text-5xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-dark">Content Blocked</h3>
                <p class="mb-2 text-dark">Your content couldn't be published due to policy violations.</p>
                <p class="text-sm text-gray-500 mb-6">Please review our community guidelines.</p>
                <button id="closeBlockedBtn" class="clay-button px-4 py-2 font-medium">Try Again</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Post Confirmation Modal -->
    <div id="deletePostModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="clay p-6 max-w-md w-full">
            <div class="text-center">
                <i class="bi bi-trash-fill text-5xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-dark">Delete Post?</h3>
                <p class="mb-6 text-dark">Are you sure you want to delete this post? This cannot be undone.</p>
                <div class="flex space-x-4 justify-center">
                    <button id="confirmDeleteBtn" class="clay-button px-4 py-2 font-medium bg-red-500 text-white">Delete</button>
                    <button id="cancelDeleteBtn" class="clay-button px-4 py-2 font-medium bg-gray-300 text-dark">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Error Modal -->
    <div id="authErrorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="clay p-6 max-w-md w-full">
            <div class="text-center">
                <i class="bi bi-exclamation-circle-fill text-5xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2 text-dark">Authentication Error</h3>
                <p id="auth-error-message" class="mb-6 text-dark">Please check your credentials and try again.</p>
                <button id="closeAuthErrorBtn" class="clay-button px-4 py-2 font-medium">Try Again</button>
            </div>
        </div>
    </div>

    <script>
        // App Slug for database operations
        const APP_SLUG = "safepost-app-123456";
        
        // Offensive words list (expanded for sensitive content detection)
        const offensiveWords = ['hate', 'terrible', 'stupid', 'abuse', 'violent', 'kill', 'porn', 'naked', 'sex', 'attack', 'racist', 'threat', 'nude', 'violence', 'fight', 'blood', 'explicit', 'fuck'];
        let activeTab = 'textOnly';
        let mediaType = null;
        let currentUser = null;
        let mediaUploadUrl = null;
        let currentChatUser = null;
        let currentPostToDelete = null;
        
        // DOM Elements
        const loginSpinner = document.getElementById('login-spinner');
        const registerSpinner = document.getElementById('register-spinner');
        const postSpinner = document.getElementById('post-spinner');
        const feedLoading = document.getElementById('feed-loading');
        const profileLoading = document.getElementById('profile-loading');
        const chatLoading = document.getElementById('chat-loading');
        const messageLoading = document.getElementById('message-loading');
        
        // AUTH FUNCTIONALITY
        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        });
        
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        });
        
        // Login Form Submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            // Validation
            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            try {
                loginSpinner.style.display = 'block';
                
                // Check if user exists in database
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users',
                        conditions: { email: email }
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.result.length > 0) {
                    const user = data.result[0];
                    
                    // Simple password check (in real app, use proper hashing)
                    if (user.password === password) {
                        currentUser = user;
                        loginSuccess();
                    } else {
                        showAuthError('Invalid password');
                    }
                } else {
                    showAuthError('User not found');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthError('An error occurred. Please try again.');
            } finally {
                loginSpinner.style.display = 'none';
            }
        });
        
        // Register Form Submission
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value.trim();
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            
            // Validation
            if (!name || !username || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }
            
            try {
                registerSpinner.style.display = 'block';
                
                // Check if email already exists
                const emailCheckResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users',
                        conditions: { email: email }
                    })
                });
                
                const emailData = await emailCheckResponse.json();
                
                if (emailData.success && emailData.result.length > 0) {
                    showAuthError('Email already in use');
                    registerSpinner.style.display = 'none';
                    return;
                }
                
                // Check if username already exists
                const usernameCheckResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users',
                        conditions: { username: username }
                    })
                });
                
                const usernameData = await usernameCheckResponse.json();
                
                if (usernameData.success && usernameData.result.length > 0) {
                    showAuthError('Username already taken');
                    registerSpinner.style.display = 'none';
                    return;
                }
                
                // Create random avatar using Unsplash
                const avatarId = Math.floor(Math.random() * 1000);
                const avatar = `https://images.unsplash.com/photo-${avatarId}?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80`;
                
                // Create new user in database
                const newUser = {
                    name,
                    username,
                    email,
                    password, // In real app, hash this password
                    avatar,
                    createdAt: new Date().toISOString(),
                    followers: [],
                    following: []
                };
                
                const createResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'create',
                        collection: 'users',
                        data: newUser
                    })
                });
                
                const createData = await createResponse.json();
                
                if (createData.success) {
                    // Get the created user with ID
                    const getUserResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: JSON.stringify({
                            appSlug: APP_SLUG,
                            action: 'read',
                            collection: 'users',
                            conditions: { email: email }
                        })
                    });
                    
                    const userData = await getUserResponse.json();
                    if (userData.success && userData.result.length > 0) {
                        currentUser = userData.result[0];
                        loginSuccess();
                    }
                } else {
                    showAuthError('Failed to create account');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthError('An error occurred. Please try again.');
            } finally {
                registerSpinner.style.display = 'none';
            }
        });
        
        function loginSuccess() {
            // Hide auth screens
            document.getElementById('auth-container').classList.add('hidden');
            
            // Show app container
            document.getElementById('app-container').classList.remove('hidden');
            
            // Set user info
            document.getElementById('user-display-name').textContent = currentUser.username;
            document.getElementById('user-avatar').src = currentUser.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&h=100&q=80';
            
            // Set profile info
            document.getElementById('profile-avatar').src = currentUser.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=200&h=200&q=80';
            document.getElementById('profile-name').textContent = currentUser.name;
            document.getElementById('profile-username').textContent = '@' + currentUser.username;
            
            // Update follower counts
            updateFollowerCounts();
            
            // Load posts
            loadFeed();
            
            // Load chat list
            loadChatList();
            
            // Load suggested users
            loadSuggestedUsers();
        }
        
        function showAuthError(message) {
            document.getElementById('auth-error-message').textContent = message;
            document.getElementById('authErrorModal').classList.remove('hidden');
        }
        
        document.getElementById('closeAuthErrorBtn').addEventListener('click', () => {
            document.getElementById('authErrorModal').classList.add('hidden');
        });
        
        // Update follower counts
        function updateFollowerCounts() {
            if (!currentUser) return;
            
            const followers = Array.isArray(currentUser.followers) ? currentUser.followers.length : 0;
            const following = Array.isArray(currentUser.following) ? currentUser.following.length : 0;
            
            document.getElementById('followers-count').textContent = followers;
            document.getElementById('following-count').textContent = following;
        }
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            currentChatUser = null;
            mediaUploadUrl = null;
            
            // Reset forms
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
            
            // Show auth container
            document.getElementById('auth-container').classList.remove('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('register-screen').classList.add('hidden');
            
            // Hide app container
            document.getElementById('app-container').classList.add('hidden');
            
            // Clear any posts
            document.getElementById('postFeed').innerHTML = '';
            document.getElementById('profile-posts').innerHTML = '';
            document.getElementById('chat-list').innerHTML = '';
            document.getElementById('message-content').innerHTML = '';
        });
        
        // Load feed posts from database
        async function loadFeed() {
            try {
                feedLoading.style.display = 'block';
                document.getElementById('feed-empty').classList.add('hidden');
                document.getElementById('postFeed').classList.add('hidden');
                
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'posts'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const posts = data.result;
                    renderFeed(posts);
                } else {
                    document.getElementById('feed-empty').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Load feed error:', error);
                document.getElementById('feed-empty').classList.remove('hidden');
            } finally {
                feedLoading.style.display = 'none';
            }
        }
        
        // Render feed posts
        function renderFeed(posts) {
            const feedEmpty = document.getElementById('feed-empty');
            const postFeed = document.getElementById('postFeed');
            postFeed.innerHTML = '';
            
            if (posts && posts.length > 0) {
                // Sort posts by timestamp, newest first
                posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                posts.forEach(post => {
                    const postDate = new Date(post.createdAt);
                    const timeAgo = getTimeAgo(postDate);
                    
                    const postElement = document.createElement('div');
                    postElement.className = 'clay-card p-4';
                    postElement.dataset.postId = post._id;
                    
                    // Check if current user is the post creator
                    const isCurrentUserPost = post.userId === currentUser._id;
                    
                    // Check if the current user has liked this post
                    const hasLiked = post.likes && post.likes.includes(currentUser._id);
                    
                    let postContent = `
                        <div class="flex items-center mb-3">
                            <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-white">
                                <img src="${post.userAvatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde'}" alt="User avatar" class="w-full h-full object-cover">
                            </div>
                            <div class="ml-3">
                                <p class="font-bold text-dark">${post.username}</p>
                                <p class="text-xs text-gray-500">${timeAgo}</p>
                            </div>
                            <div class="ml-auto flex">
                                ${!isCurrentUserPost ? 
                                  `<button class="clay-button px-3 py-1 text-xs message-user-btn mr-2" data-user-id="${post.userId}" data-username="${post.username}" data-avatar="${post.userAvatar || ''}">
                                    <i class="bi bi-chat"></i> Message
                                   </button>` : 
                                  `<button class="clay-button px-3 py-1 text-xs delete-post-btn bg-red-500 text-white">
                                    <i class="bi bi-trash"></i> Delete
                                   </button>`}
                            </div>
                        </div>
                        <p class="mb-3 text-dark">${post.caption}</p>
                    `;
                    
                    // Add media if present
                    if (post.mediaType === 'image' && post.mediaUrl) {
                        postContent += `<img src="${post.mediaUrl}" class="w-full h-auto rounded-xl mb-3" alt="Post image">`;
                    } else if (post.mediaType === 'video' && post.mediaUrl) {
                        postContent += `<video src="${post.mediaUrl}" class="w-full h-auto rounded-xl mb-3" controls></video>`;
                    }
                    
                    // Add like button and count
                    const likeCount = post.likes ? post.likes.length : 0;
                    postContent += `
                        <div class="flex items-center mt-4 pt-3 border-t border-gray-200">
                            <button class="like-button flex items-center ${hasLiked ? 'text-primary' : 'text-dark'}" data-post-id="${post._id}">
                                <i class="bi ${hasLiked ? 'bi-heart-fill' : 'bi-heart'} text-xl mr-1"></i>
                                <span class="like-count">${likeCount}</span>
                            </button>
                            
                            <button class="comment-button flex items-center ml-4 text-dark">
                                <i class="bi bi-chat-dots text-xl mr-1"></i>
                                <span>${post.comments ? post.comments.length : 0}</span>
                            </button>
                        </div>
                    `;
                    
                    postElement.innerHTML = postContent;
                    postFeed.appendChild(postElement);
                });
                
                // Add event listeners for like buttons
                document.querySelectorAll('.like-button').forEach(button => {
                    button.addEventListener('click', handleLikePost);
                });
                
                // Add event listeners for message buttons
                document.querySelectorAll('.message-user-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userId;
                        const username = e.currentTarget.dataset.username;
                        const avatar = e.currentTarget.dataset.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde';
                        
                        openChat({
                            _id: userId,
                            username: username,
                            avatar: avatar
                        });
                        
                        switchSection('messages');
                    });
                });
                
                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-post-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const postElement = e.target.closest('[data-post-id]');
                        const postId = postElement.dataset.postId;
                        showDeletePostModal(postId);
                    });
                });
                
                feedEmpty.classList.add('hidden');
                postFeed.classList.remove('hidden');
            } else {
                feedEmpty.classList.remove('hidden');
                postFeed.classList.add('hidden');
            }
        }
        
        // Show delete post confirmation modal
        function showDeletePostModal(postId) {
            currentPostToDelete = postId;
            document.getElementById('deletePostModal').classList.remove('hidden');
        }
        
        // Delete post confirmation
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!currentPostToDelete) {
                document.getElementById('deletePostModal').classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'delete',
                        collection: 'posts',
                        id: currentPostToDelete
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Refresh both feed and profile posts
                    loadFeed();
                    loadProfilePosts();
                }
            } catch (error) {
                console.error('Delete post error:', error);
            } finally {
                document.getElementById('deletePostModal').classList.add('hidden');
                currentPostToDelete = null;
            }
        });
        
        // Cancel delete
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            document.getElementById('deletePostModal').classList.add('hidden');
            currentPostToDelete = null;
        });
        
        // Handle like post
        async function handleLikePost(e) {
            if (!currentUser) return;
            
            const button = e.currentTarget;
            const postId = button.dataset.postId;
            const iconElement = button.querySelector('i');
            const countElement = button.querySelector('.like-count');
            
            try {
                // Get current post data
                const getResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'posts',
                        conditions: { _id: postId }
                    })
                });
                
                const getData = await getResponse.json();
                
                if (getData.success && getData.result.length > 0) {
                    const post = getData.result[0];
                    let likes = Array.isArray(post.likes) ? [...post.likes] : [];
                    
                    const hasLiked = likes.includes(currentUser._id);
                    
                    // Toggle like
                    if (hasLiked) {
                        // Unlike
                        likes = likes.filter(id => id !== currentUser._id);
                    } else {
                        // Like
                        likes.push(currentUser._id);
                    }
                    
                    // Update post
                    const updateResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: JSON.stringify({
                            appSlug: APP_SLUG,
                            action: 'update',
                            collection: 'posts',
                            conditions: { _id: postId },
                            data: { likes }
                        })
                    });
                    
                    const updateData = await updateResponse.json();
                    
                    if (updateData.success) {
                        // Update UI
                        if (hasLiked) {
                            // Changed to unlike
                            iconElement.classList.remove('bi-heart-fill');
                            iconElement.classList.add('bi-heart');
                            button.classList.remove('text-primary');
                            button.classList.add('text-dark');
                        } else {
                            // Changed to like
                            iconElement.classList.remove('bi-heart');
                            iconElement.classList.add('bi-heart-fill');
                            button.classList.remove('text-dark');
                            button.classList.add('text-primary');
                        }
                        
                        countElement.textContent = likes.length;
                    }
                }
            } catch (error) {
                console.error('Like post error:', error);
            }
        }
        
        // Load user profile posts
        async function loadProfilePosts() {
            if (!currentUser || !currentUser._id) return;
            
            try {
                profileLoading.style.display = 'block';
                document.getElementById('profile-posts').classList.add('hidden');
                
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'posts',
                        conditions: { userId: currentUser._id }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const posts = data.result;
                    
                    // Update post count
                    document.getElementById('post-count').textContent = posts.length;
                    
                    renderProfilePosts(posts);
                }
            } catch (error) {
                console.error('Load profile posts error:', error);
            } finally {
                profileLoading.style.display = 'none';
                document.getElementById('profile-posts').classList.remove('hidden');
            }
        }
        
        // Render user profile posts
        function renderProfilePosts(posts) {
            const profilePosts = document.getElementById('profile-posts');
            profilePosts.innerHTML = '';
            
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'clay-card aspect-square overflow-hidden relative';
                    postElement.dataset.postId = post._id;
                    
                    if (post.mediaType === 'image' && post.mediaUrl) {
                        postElement.innerHTML = `
                            <img src="${post.mediaUrl}" class="w-full h-full object-cover" alt="Post">
                            <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 delete-profile-post">
                                <i class="bi bi-trash"></i>
                            </button>
                        `;
                    } else if (post.mediaType === 'video' && post.mediaUrl) {
                        postElement.innerHTML = `
                            <div class="w-full h-full relative">
                                <img src="https://images.unsplash.com/photo-1603190287605-e6ade32fa852" class="w-full h-full object-cover" alt="Video thumbnail">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <i class="bi bi-play-circle-fill text-white text-4xl"></i>
                                </div>
                                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 delete-profile-post">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        // Text-only post
                        postElement.innerHTML = `
                            <div class="w-full h-full flex items-center justify-center p-3 bg-white">
                                <p class="text-sm line-clamp-4 overflow-hidden text-dark">${post.caption}</p>
                                <button class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 delete-profile-post">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        `;
                    }
                    
                    profilePosts.appendChild(postElement);
                });
                
                // Add event listeners for delete buttons in profile
                document.querySelectorAll('.delete-profile-post').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const postElement = e.target.closest('[data-post-id]');
                        const postId = postElement.dataset.postId;
                        showDeletePostModal(postId);
                    });
                });
                
            } else {
                // No posts
                profilePosts.innerHTML = `
                    <div class="text-center py-8 col-span-2 text-gray-500">
                        <i class="bi bi-image text-4xl"></i>
                        <p class="mt-2">No posts yet</p>
                    </div>
                `;
            }
        }
        
        // Load suggested users
        async function loadSuggestedUsers() {
            const suggestedContainer = document.getElementById('suggested-users');
            const suggestedLoading = document.getElementById('suggested-loading');
            
            try {
                suggestedLoading.style.display = 'block';
                
                // Get all users except current user
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.result.length > 0) {
                    // Filter out current user and users already following
                    let suggestedUsers = data.result.filter(user => 
                        user._id !== currentUser._id && 
                        (!currentUser.following || !currentUser.following.includes(user._id))
                    );
                    
                    // Limit to 6 users
                    suggestedUsers = suggestedUsers.slice(0, 6);
                    
                    // Clear container
                    suggestedContainer.innerHTML = '';
                    
                    if (suggestedUsers.length === 0) {
                        suggestedContainer.innerHTML = `
                            <div class="col-span-3 text-center py-4 text-gray-500">
                                <p>No suggested users at this time</p>
                            </div>
                        `;
                    } else {
                        suggestedUsers.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = 'clay-card p-3 flex flex-col items-center';
                            userElement.innerHTML = `
                                <img src="${user.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde'}" alt="${user.username}" class="w-12 h-12 avatar-circle">
                                <p class="font-bold mt-2 text-center text-dark">${user.username}</p>
                                <button class="follow-btn clay-button px-3 py-1 text-xs mt-2" data-user-id="${user._id}">Follow</button>
                            `;
                            suggestedContainer.appendChild(userElement);
                        });
                        
                        // Add event listeners
                        document.querySelectorAll('.follow-btn').forEach(btn => {
                            btn.addEventListener('click', handleFollowUser);
                        });
                    }
                }
            } catch (error) {
                console.error('Load suggested users error:', error);
                suggestedContainer.innerHTML = `
                    <div class="col-span-3 text-center py-4 text-red-500">
                        <p>Error loading suggested users</p>
                    </div>
                `;
            } finally {
                suggestedLoading.style.display = 'none';
            }
        }
        
        // Follow button in chat
        document.getElementById('follow-btn').addEventListener('click', async function() {
            if (!currentUser || !currentChatUser) return;
            
            const button = this;
            button.textContent = 'Loading...';
            
            try {
                const isFollowing = await isUserFollowing(currentChatUser._id);
                
                if (isFollowing) {
                    // Unfollow
                    await unfollowUser(currentChatUser._id);
                    button.textContent = 'Follow';
                } else {
                    // Follow
                    await followUser(currentChatUser._id);
                    button.textContent = 'Unfollow';
                }
                
                updateFollowerCounts();
                
            } catch (error) {
                console.error('Follow error:', error);
                button.textContent = isFollowing ? 'Unfollow' : 'Follow';
            }
        });
        
        // Check if current user is following another user
        async function isUserFollowing(userId) {
            if (!currentUser || !currentUser.following) return false;
            return currentUser.following.includes(userId);
        }
        
        // Handle follow button click
        async function handleFollowUser(e) {
            if (!currentUser) return;
            
            const button = e.currentTarget;
            const userId = button.dataset.userId;
            
            button.disabled = true;
            button.textContent = 'Loading...';
            
            try {
                const isFollowing = await isUserFollowing(userId);
                
                if (isFollowing) {
                    await unfollowUser(userId);
                    button.textContent = 'Follow';
                } else {
                    await followUser(userId);
                    button.textContent = 'Unfollow';
                }
                
                updateFollowerCounts();
                
            } catch (error) {
                console.error('Follow error:', error);
            } finally {
                button.disabled = false;
            }
        }
        
        // Follow a user
        async function followUser(userId) {
            if (!currentUser || !userId) return;
            
            try {
                // Get current user data to ensure it's up to date
                const getCurrentResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users',
                        conditions: { _id: currentUser._id }
                    })
                });
                
                const currentData = await getCurrentResponse.json();
                
                if (currentData.success && currentData.result.length > 0) {
                    const updatedCurrentUser = currentData.result[0];
                    let following = Array.isArray(updatedCurrentUser.following) ? [...updatedCurrentUser.following] : [];
                    
                    // Add userId to following if not already there
                    if (!following.includes(userId)) {
                        following.push(userId);
                        
                        // Update current user
                        const updateCurrentResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                            },
                            body: JSON.stringify({
                                appSlug: APP_SLUG,
                                action: 'update',
                                collection: 'users',
                                conditions: { _id: currentUser._id },
                                data: { following }
                            })
                        });
                        
                        const updateCurrentData = await updateCurrentResponse.json();
                        
                        if (updateCurrentData.success) {
                            // Get target user data
                            const getTargetResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                                },
                                body: JSON.stringify({
                                    appSlug: APP_SLUG,
                                    action: 'read',
                                    collection: 'users',
                                    conditions: { _id: userId }
                                })
                            });
                            
                            const targetData = await getTargetResponse.json();
                            
                            if (targetData.success && targetData.result.length > 0) {
                                const targetUser = targetData.result[0];
                                let followers = Array.isArray(targetUser.followers) ? [...targetUser.followers] : [];
                                
                                // Add currentUser to followers if not already there
                                if (!followers.includes(currentUser._id)) {
                                    followers.push(currentUser._id);
                                    
                                    // Update target user
                                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                                        },
                                        body: JSON.stringify({
                                            appSlug: APP_SLUG,
                                            action: 'update',
                                            collection: 'users',
                                            conditions: { _id: userId },
                                            data: { followers }
                                        })
                                    });
                                }
                            }
                            
                            // Update current user in memory
                            currentUser.following = following;
                        }
                    }
                }
            } catch (error) {
                console.error('Follow user error:', error);
                throw error;
            }
        }
        
        // Unfollow a user
        async function unfollowUser(userId) {
            if (!currentUser || !userId) return;
            
            try {
                // Get current user data to ensure it's up to date
                const getCurrentResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users',
                        conditions: { _id: currentUser._id }
                    })
                });
                
                const currentData = await getCurrentResponse.json();
                
                if (currentData.success && currentData.result.length > 0) {
                    const updatedCurrentUser = currentData.result[0];
                    let following = Array.isArray(updatedCurrentUser.following) ? [...updatedCurrentUser.following] : [];
                    
                    // Remove userId from following
                    following = following.filter(id => id !== userId);
                    
                    // Update current user
                    const updateCurrentResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: JSON.stringify({
                            appSlug: APP_SLUG,
                            action: 'update',
                            collection: 'users',
                            conditions: { _id: currentUser._id },
                            data: { following }
                        })
                    });
                    
                    const updateCurrentData = await updateCurrentResponse.json();
                    
                    if (updateCurrentData.success) {
                        // Get target user data
                        const getTargetResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                            },
                            body: JSON.stringify({
                                appSlug: APP_SLUG,
                                action: 'read',
                                collection: 'users',
                                conditions: { _id: userId }
                            })
                        });
                        
                        const targetData = await getTargetResponse.json();
                        
                        if (targetData.success && targetData.result.length > 0) {
                            const targetUser = targetData.result[0];
                            let followers = Array.isArray(targetUser.followers) ? [...targetUser.followers] : [];
                            
                            // Remove currentUser from followers
                            followers = followers.filter(id => id !== currentUser._id);
                            
                            // Update target user
                            await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                                },
                                body: JSON.stringify({
                                    appSlug: APP_SLUG,
                                    action: 'update',
                                    collection: 'users',
                                    conditions: { _id: userId },
                                    data: { followers }
                                })
                            });
                        }
                        
                        // Update current user in memory
                        currentUser.following = following;
                    }
                }
            } catch (error) {
                console.error('Unfollow user error:', error);
                throw error;
            }
        }
        
        // Load chat list
        async function loadChatList() {
            const chatListContainer = document.getElementById('chat-list');
            
            try {
                chatLoading.style.display = 'block';
                
                // Get all users
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'users'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Filter out current user
                    const users = data.result.filter(user => user._id !== currentUser._id);
                    
                    // Clear container and populate with users
                    chatListContainer.innerHTML = '';
                    
                    if (users.length === 0) {
                        chatListContainer.innerHTML = `
                            <div class="text-center py-4">
                                <p class="text-gray-500 text-sm">No users available</p>
                            </div>
                        `;
                    } else {
                        users.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = 'flex items-center border-b border-gray-200 pb-2 cursor-pointer hover:bg-gray-100 p-2 rounded-lg';
                            userElement.dataset.userId = user._id;
                            userElement.innerHTML = `
                                <img src="${user.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde'}" alt="${user.username}" class="w-8 h-8 avatar-circle">
                                <div class="ml-2 overflow-hidden">
                                    <p class="font-medium text-sm text-dark">${user.username}</p>
                                </div>
                            `;
                            chatListContainer.appendChild(userElement);
                            
                            // Add click event
                            userElement.addEventListener('click', () => openChat(user));
                        });
                    }
                    
                    // Add search functionality
                    const searchInput = document.getElementById('search-users');
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const userElements = chatListContainer.querySelectorAll('[data-user-id]');
                        
                        userElements.forEach(el => {
                            const username = el.querySelector('p').textContent.toLowerCase();
                            if (username.includes(searchTerm)) {
                                el.classList.remove('hidden');
                            } else {
                                el.classList.add('hidden');
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('Load chat list error:', error);
                chatListContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-500 text-sm">Error loading users</p>
                    </div>
                `;
            } finally {
                chatLoading.style.display = 'none';
            }
        }
        
        // Open chat with user
        async function openChat(user) {
            if (!user) return;
            
            currentChatUser = user;
            
            // Update header
            document.getElementById('chat-avatar').src = user.avatar || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde';
            document.getElementById('chat-username').textContent = user.username;
            
            // Check if following
            const isFollowing = await isUserFollowing(user._id);
            const followBtn = document.getElementById('follow-btn');
            followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
            
            // Show loading
            messageLoading.style.display = 'flex';
            document.getElementById('message-content').classList.add('hidden');
            
            // Load messages
            loadChatMessages(user._id);
        }
        
        // Load chat messages
        async function loadChatMessages(userId) {
            if (!currentUser || !userId) return;
            
            const messageContainer = document.getElementById('message-content');
            
            try {
                // Get conversations
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'read',
                        collection: 'messages',
                        conditions: {
                            $or: [
                                { senderId: currentUser._id, receiverId: userId },
                                { senderId: userId, receiverId: currentUser._id }
                            ]
                        }
                    })
                });
                
                const data = await response.json();
                
                // Clear container
                messageContainer.innerHTML = '';
                
                if (data.success) {
                    const messages = data.result;
                    
                    if (messages.length === 0) {
                        messageContainer.innerHTML = `
                            <div class="flex items-center justify-center h-full">
                                <p class="text-gray-500">No messages yet. Start the conversation!</p>
                            </div>
                        `;
                    } else {
                        // Sort messages by timestamp
                        messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        
                        messages.forEach(msg => {
                            const messageElement = document.createElement('div');
                            const isSent = msg.senderId === currentUser._id;
                            
                            messageElement.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                            messageElement.innerHTML = `
                                <p class="text-current">${msg.content}</p>
                                <p class="text-xs opacity-70 text-right mt-1">${formatMessageTime(msg.timestamp)}</p>
                            `;
                            
                            messageContainer.appendChild(messageElement);
                        });
                        
                        // Scroll to bottom
                        const messagesContainer = document.getElementById('messages-container');
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    
                    messageContainer.classList.remove('hidden');
                } else {
                    messageContainer.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <p class="text-red-500">Error loading messages</p>
                        </div>
                    `;
                    messageContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Load messages error:', error);
                messageContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-red-500">Error loading messages</p>
                    </div>
                `;
                messageContainer.classList.remove('hidden');
            } finally {
                messageLoading.style.display = 'none';
            }
        }
        
        // Format message time
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Send message
        document.getElementById('send-message-btn').addEventListener('click', sendMessage);
        
        // Send message on Enter key
        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            if (!currentUser || !currentChatUser) return;
            
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            try {
                // Create message object
                const newMessage = {
                    senderId: currentUser._id,
                    senderName: currentUser.username,
                    receiverId: currentChatUser._id,
                    receiverName: currentChatUser.username,
                    content,
                    timestamp: new Date().toISOString(),
                    isRead: false
                };
                
                // Save to database
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        appSlug: APP_SLUG,
                        action: 'create',
                        collection: 'messages',
                        data: newMessage
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input
                    messageInput.value = '';
                    
                    // Add message to UI
                    const messageContainer = document.getElementById('message-content');
                    const messageElement = document.createElement('div');
                    
                    messageElement.className = 'message-bubble message-sent';
                    messageElement.innerHTML = `
                        <p class="text-current">${content}</p>
                        <p class="text-xs opacity-70 text-right mt-1">${formatMessageTime(new Date().toISOString())}</p>
                    `;
                    
                    messageContainer.appendChild(messageElement);
                    
                    // Scroll to bottom
                    const messagesContainer = document.getElementById('messages-container');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Send message error:', error);
            }
        }
        
        // NAVIGATION
        document.getElementById('nav-feed').addEventListener('click', () => {
            switchSection('feed');
            loadFeed();
        });
        
        document.getElementById('nav-post').addEventListener('click', () => {
            switchSection('post');
            resetPostForm();
        });
        
        document.getElementById('nav-messages').addEventListener('click', () => {
            switchSection('messages');
            loadChatList();
        });
        
        document.getElementById('nav-profile').addEventListener('click', () => {
            switchSection('profile');
            loadProfilePosts();
            loadSuggestedUsers();
        });
        
        function switchSection(section) {
            // Hide all sections
            document.getElementById('feed-section').classList.add('hidden');
            document.getElementById('post-section').classList.add('hidden');
            document.getElementById('messages-section').classList.add('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            
            // Remove active class from all nav items
            document.getElementById('nav-feed').classList.remove('active');
            document.getElementById('nav-post').classList.remove('active');
            document.getElementById('nav-messages').classList.remove('active');
            document.getElementById('nav-profile').classList.remove('active');
            
            // Show selected section and activate nav item
            document.getElementById(`${section}-section`).classList.remove('hidden');
            document.getElementById(`nav-${section}`).classList.add('active');
        }
        
        // Text moderation
        document.getElementById('postCaption').addEventListener('input', (e) => {
            const text = e.target.value.toLowerCase();
            const warning = document.getElementById('textWarning');
            const hasOffensiveContent = offensiveWords.some(word => text.includes(word));
            warning.classList.toggle('hidden', !hasOffensiveContent);
        });

        // Tab Switching
        document.getElementById('textOnlyTab').addEventListener('click', () => switchTab('textOnly'));
        document.getElementById('imageTab').addEventListener('click', () => switchTab('image'));
        document.getElementById('videoTab').addEventListener('click', () => switchTab('video'));

        function switchTab(tabName) {
            // Hide all content first
            document.getElementById('textOnlyContent').classList.add('hidden');
            document.getElementById('imageContent').classList.add('hidden');
            document.getElementById('videoContent').classList.add('hidden');
            
            // Remove active class from all tabs
            document.getElementById('textOnlyTab').classList.remove('tab-active');
            document.getElementById('imageTab').classList.remove('tab-active');
            document.getElementById('videoTab').classList.remove('tab-active');
            
            // Show selected content and activate tab
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.add('tab-active');
            
            activeTab = tabName;
            mediaType = tabName === 'textOnly' ? null : tabName;
        }

        // Image handling
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });

        // Add drag and drop support for images
        const imageDropArea = document.getElementById('imageDropArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            imageDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            imageDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            imageDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            imageDropArea.classList.add('bg-blue-100');
        }
        
        function unhighlight() {
            imageDropArea.classList.remove('bg-blue-100');
        }
        
        imageDropArea.addEventListener('drop', handleImageDrop, false);
        
        function handleImageDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('image/')) {
                handleImageUpload(file);
            }
        }
        
        async function handleImageUpload(file) {
            document.getElementById('imageUploadPrompt').classList.add('hidden');
            document.getElementById('imagePreview').classList.remove('hidden');
            
            // Display image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('uploadedImage').src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            try {
                // Upload to storage
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userId', currentUser._id || 'user123');
                formData.append('appSlug', APP_SLUG);
                
                const uploadResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (uploadData.success) {
                    mediaUploadUrl = uploadData.url;
                    simulateImageModeration();
                } else {
                    console.error('Upload failed:', uploadData);
                    showImageError();
                }
            } catch (error) {
                console.error('Image upload error:', error);
                showImageError();
            }
        }

        function showImageError() {
            const status = document.getElementById('imageStatus');
            status.textContent = '❌ Upload Failed';
            status.className = 'absolute top-4 right-4 px-4 py-2 rounded-lg font-bold bg-red-500 text-white';
            status.classList.remove('hidden');
        }

        // Video handling
        document.getElementById('videoInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleVideoUpload(file);
            }
        });
        
        // Add drag and drop support for videos
        const videoDropArea = document.getElementById('videoDropArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            videoDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            videoDropArea.addEventListener(eventName, highlightVideo, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            videoDropArea.addEventListener(eventName, unhighlightVideo, false);
        });
        
        function highlightVideo() {
            videoDropArea.classList.add('bg-blue-100');
        }
        
        function unhighlightVideo() {
            videoDropArea.classList.remove('bg-blue-100');
        }
        
        videoDropArea.addEventListener('drop', handleVideoDrop, false);
        
        function handleVideoDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && file.type.startsWith('video/')) {
                handleVideoUpload(file);
            }
        }
        
        async function handleVideoUpload(file) {
            document.getElementById('videoUploadPrompt').classList.add('hidden');
            document.getElementById('videoPreview').classList.remove('hidden');
            
            // Display video preview
            const video = document.getElementById('uploadedVideo');
            video.src = URL.createObjectURL(file);
            
            try {
                // Upload to storage
                const formData = new FormData();
                formData.append('file', file);
                formData.append('userId', currentUser._id || 'user123');
                formData.append('appSlug', APP_SLUG);
                
                const uploadResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: formData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (uploadData.success) {
                    mediaUploadUrl = uploadData.url;
                    simulateVideoModeration();
                } else {
                    console.error('Upload failed:', uploadData);
                    showVideoError();
                }
            } catch (error) {
                console.error('Video upload error:', error);
                showVideoError();
            }
        }
        
        function showVideoError() {
            const status = document.getElementById('videoStatus');
            status.textContent = '❌ Upload Failed';
            status.className = 'absolute top-4 right-4 px-4 py-2 rounded-lg font-bold bg-red-500 text-white';
            status.classList.remove('hidden');
        }

        function simulateImageModeration() {
            const processing = document.getElementById('imageProcessing');
            const status = document.getElementById('imageStatus');
            
            processing.style.display = 'flex';
            status.classList.add('hidden');
            status.className = 'absolute top-4 right-4 px-4 py-2 rounded-lg font-bold';

            // Simulate AI analysis
            simulateAIAnalysis('image', document.getElementById('uploadedImage').src)
                .then(isSafe => {
                    processing.style.display = 'none';
                    status.classList.remove('hidden');
                    
                    status.textContent = isSafe ? '✓ Safe Content' : '⚠ Not Allowed';
                    status.classList.add(isSafe ? 'bg-green-500' : 'bg-red-500');
                    status.classList.add('text-white');
                    
                    // Store result for when user tries to post
                    document.getElementById('uploadedImage').dataset.isSafe = isSafe;
                })
                .catch(err => {
                    console.error(err);
                    processing.style.display = 'none';
                    status.classList.remove('hidden');
                    status.textContent = '⚠ Analysis Error';
                    status.classList.add('bg-red-500', 'text-white');
                    document.getElementById('uploadedImage').dataset.isSafe = 'false';
                });
        }

        function simulateVideoModeration() {
            const processing = document.getElementById('videoProcessing');
            const status = document.getElementById('videoStatus');
            
            processing.style.display = 'flex';
            status.classList.add('hidden');
            status.className = 'absolute top-4 right-4 px-4 py-2 rounded-lg font-bold';

            // Simulate longer processing for video+audio
            simulateAIAnalysis('video', mediaUploadUrl)
                .then(isSafe => {
                    setTimeout(() => {
                        processing.style.display = 'none';
                        status.classList.remove('hidden');
                        
                        status.textContent = isSafe ? '✓ Safe Content' : '⚠ Not Allowed';
                        status.classList.add(isSafe ? 'bg-green-500' : 'bg-red-500');
                        status.classList.add('text-white');
                        
                        // Store result for when user tries to post
                        document.getElementById('uploadedVideo').dataset.isSafe = isSafe;
                    }, 1500); // Extra delay for video
                })
                .catch(err => {
                    console.error(err);
                    processing.style.display = 'none';
                    status.classList.remove('hidden');
                    status.textContent = '⚠ Analysis Error';
                    status.classList.add('bg-red-500', 'text-white');
                    document.getElementById('uploadedVideo').dataset.isSafe = 'false';
                });
        }
        
        // Simulate AI analysis with the AI endpoint
        function simulateAIAnalysis(mediaType, mediaUrl) {
            return new Promise((resolve) => {
                // For demo purposes, use random result (70% chance of being safe)
                const isSafe = Math.random() > 0.3;
                setTimeout(() => {
                    resolve(isSafe);
                }, 1500);
                
                // In a real implementation, you would call the AI endpoint
                /*
                return fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: "user",
                                content: [
                                    {
                                        type: "text",
                                        text: `Check if this ${mediaType} contains inappropriate content`
                                    },
                                    {
                                        type: "image_url",
                                        image_url: {
                                            url: mediaUrl
                                        }
                                    }
                                ]
                            }
                        ]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Parse AI response to determine if content is safe
                    return !data.message.toLowerCase().includes('inappropriate');
                });
                */
            });
        }
        
        // Post button handler
        document.getElementById('postButton').addEventListener('click', async () => {
            if (!currentUser) {
                showAuthError('You must be logged in to post');
                return;
            }
            
            const caption = document.getElementById('postCaption').value.trim();
            if (!caption) {
                showAuthError('Please add a caption to your post');
                return;
            }
            
            const hasOffensiveText = offensiveWords.some(word => caption.toLowerCase().includes(word));
            
            let mediaIsSafe = true;
            
            // Check if any media is unsafe
            if (activeTab === 'image') {
                const img = document.getElementById('uploadedImage');
                if (!img.src || img.dataset.isSafe === 'false') {
                    mediaIsSafe = false;
                }
            } else if (activeTab === 'video') {
                const video = document.getElementById('uploadedVideo');
                if (!video.src || video.dataset.isSafe === 'false') {
                    mediaIsSafe = false;
                }
            }
            
            // Check if post should be allowed
            const isPostAllowed = !hasOffensiveText && mediaIsSafe;
            
            if (isPostAllowed) {
                try {
                    postSpinner.style.display = 'block';
                    
                    // Create post object
                    const newPost = {
                        userId: currentUser._id,
                        username: currentUser.username,
                        userAvatar: currentUser.avatar,
                        caption: caption,
                        mediaType: activeTab === 'textOnly' ? null : activeTab,
                        mediaUrl: mediaUploadUrl,
                        likes: [],
                        comments: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    // Save post to database
                    const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: JSON.stringify({
                            appSlug: APP_SLUG,
                            action: 'create',
                            collection: 'posts',
                            data: newPost
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showSuccessModal();
                        
                        // Reset media upload URL
                        mediaUploadUrl = null;
                        
                        // Refresh feed
                        loadFeed();
                        
                        // Refresh profile posts
                        loadProfilePosts();
                    } else {
                        showBlockedModal();
                    }
                } catch (error) {
                    console.error('Post creation error:', error);
                    showBlockedModal();
                } finally {
                    postSpinner.style.display = 'none';
                }
            } else {
                showBlockedModal();
            }
        });
        
        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
        }
        
        function showBlockedModal() {
            document.getElementById('blockedModal').classList.remove('hidden');
        }
        
        // Modal close buttons
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('successModal').classList.add('hidden');
            resetPostForm();
            switchSection('feed');
        });
        
        document.getElementById('closeBlockedBtn').addEventListener('click', () => {
            document.getElementById('blockedModal').classList.add('hidden');
        });
        
        // Reset post form
        function resetPostForm() {
            document.getElementById('postCaption').value = '';
            document.getElementById('textWarning').classList.add('hidden');
            
            // Reset image view
            document.getElementById('imageUploadPrompt').classList.remove('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('uploadedImage').src = '';
            document.getElementById('uploadedImage').removeAttribute('data-is-safe');
            
            // Reset video view
            document.getElementById('videoUploadPrompt').classList.remove('hidden');
            document.getElementById('videoPreview').classList.add('hidden');
            document.getElementById('uploadedVideo').src = '';
            document.getElementById('uploadedVideo').removeAttribute('data-is-safe');
            
            // Reset to text only tab
            switchTab('textOnly');
            
            // Reset media upload URL
            mediaUploadUrl = null;
        }
        
        // Helper function to format time
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval > 1) return interval + ' years ago';
            if (interval === 1) return interval + ' year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return interval + ' months ago';
            if (interval === 1) return interval + ' month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return interval + ' days ago';
            if (interval === 1) return interval + ' day ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return interval + ' hours ago';
            if (interval === 1) return interval + ' hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return interval + ' minutes ago';
            if (interval === 1) return interval + ' minute ago';
            
            if (seconds < 10) return 'just now';
            
            return Math.floor(seconds) + ' seconds ago';
        }
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>